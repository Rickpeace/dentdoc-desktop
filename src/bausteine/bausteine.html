<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DentDoc Bausteine</title>
  <link rel="stylesheet" href="../styles/design-system.css">
  <style>
    .main-content {
      padding-bottom: 80px;
    }

    .page-header {
      margin-bottom: var(--space-6);
      animation: slideUp 0.3s ease-out;
    }

    .page-header h1 {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
    }

    .page-header h1 svg {
      width: 32px;
      height: 32px;
      color: var(--primary-500);
    }

    .page-header p {
      color: var(--text-tertiary);
    }

    .path-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: 0.8125rem;
    }

    .path-info svg {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      flex-shrink: 0;
    }

    .path-info span {
      color: var(--text-secondary);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .path-info button {
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
    }

    .info-box {
      margin-bottom: var(--space-6);
      animation: slideUp 0.35s ease-out;
    }

    .toolbar {
      display: flex;
      gap: var(--space-3);
      margin-bottom: var(--space-5);
      flex-wrap: wrap;
      animation: slideUp 0.4s ease-out;
    }

    .toolbar-right {
      margin-left: auto;
      display: flex;
      gap: var(--space-3);
    }

    /* Kategorien-Ansicht */
    .categories-container {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .category {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      overflow: hidden;
      animation: slideUp 0.3s ease-out;
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-4) var(--space-5);
      background: rgba(249, 115, 22, 0.05);
      border-bottom: 1px solid var(--border-default);
      cursor: pointer;
      user-select: none;
    }

    .category-header:hover {
      background: rgba(249, 115, 22, 0.1);
    }

    .category-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .category-chevron {
      width: 20px;
      height: 20px;
      color: var(--primary-500);
      transition: transform var(--transition-fast);
    }

    .category.collapsed .category-chevron {
      transform: rotate(-90deg);
    }

    .category-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .category-name-input {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      background: transparent;
      border: none;
      border-bottom: 2px solid var(--primary-500);
      outline: none;
      padding: 0;
      width: 200px;
    }

    .category-count {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 8px;
      border-radius: var(--radius-full);
    }

    .category-actions {
      display: flex;
      gap: var(--space-2);
    }

    .category-actions button {
      padding: var(--space-1) var(--space-2);
      font-size: 0.75rem;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }

    .category-header:hover .category-actions button {
      opacity: 1;
    }

    .category-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .category.collapsed .category-content {
      max-height: 0;
    }

    .bausteine-list {
      padding: var(--space-2);
    }

    .baustein-item {
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-2);
      background: rgba(0, 0, 0, 0.2);
      transition: all var(--transition-fast);
    }

    .baustein-item:last-child {
      margin-bottom: 0;
    }

    .baustein-item:hover {
      border-color: var(--border-hover);
      background: rgba(0, 0, 0, 0.3);
    }

    .baustein-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) var(--space-4);
      cursor: pointer;
    }

    .baustein-title {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .baustein-chevron {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      transition: transform var(--transition-fast);
    }

    .baustein-item.open .baustein-chevron {
      transform: rotate(90deg);
      color: var(--primary-500);
    }

    .baustein-name {
      font-weight: 500;
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .baustein-id {
      font-size: 0.625rem;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.3);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      font-family: var(--font-mono);
    }

    .baustein-meta {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .badge {
      font-size: 0.625rem;
      padding: 3px 8px;
      border-radius: var(--radius-full);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-default {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success-500);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .badge-custom {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info-500);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .baustein-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .baustein-item.open .baustein-content {
      max-height: 600px;
    }

    .baustein-content-inner {
      padding: var(--space-3) var(--space-4) var(--space-4);
      border-top: 1px solid var(--border-default);
    }

    .baustein-field {
      margin-bottom: var(--space-3);
    }

    .baustein-field:last-child {
      margin-bottom: 0;
    }

    .baustein-field label {
      display: block;
      font-size: 0.6875rem;
      color: var(--text-muted);
      margin-bottom: var(--space-1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .baustein-field textarea {
      width: 100%;
      min-height: 80px;
      padding: var(--space-3);
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.8125rem;
      resize: vertical;
      font-family: inherit;
      line-height: 1.6;
      transition: all var(--transition-fast);
    }

    .baustein-field textarea:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: none;
    }

    .baustein-field input[type="text"] {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.8125rem;
      transition: all var(--transition-fast);
    }

    .baustein-field input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: none;
    }

    .baustein-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-3);
      padding-top: var(--space-3);
      border-top: 1px solid var(--border-default);
    }

    .baustein-actions-left {
      display: flex;
      gap: var(--space-2);
    }

    .btn-icon {
      padding: var(--space-2);
      background: transparent;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-icon:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .btn-icon.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-500);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-icon svg {
      width: 16px;
      height: 16px;
    }

    .btn-reset {
      background: rgba(249, 115, 22, 0.1);
      color: var(--primary-500);
      border: 1px solid rgba(249, 115, 22, 0.3);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-md);
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .btn-reset:hover:not(:disabled) {
      background: rgba(249, 115, 22, 0.2);
      border-color: var(--primary-500);
    }

    .btn-reset:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Empty State */
    .empty-category {
      padding: var(--space-6);
      text-align: center;
      color: var(--text-muted);
      font-size: 0.875rem;
    }

    .empty-category button {
      margin-top: var(--space-3);
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(10, 10, 11, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: var(--space-3) var(--space-6);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border-default);
      z-index: 100;
    }

    .status-message {
      font-size: 0.875rem;
      color: var(--text-tertiary);
    }

    .status-message.success {
      color: var(--success-500);
    }

    .status-message.error {
      color: var(--error-500);
    }

    .status-message.warning {
      color: var(--primary-500);
    }

    .btn-sm {
      padding: var(--space-2) var(--space-4);
      font-size: 0.8125rem;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-tertiary);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      max-width: 520px;
      width: 90%;
      animation: slideUp 0.3s ease-out;
    }

    .modal h2 {
      color: var(--text-primary);
      margin-bottom: var(--space-5);
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .modal textarea {
      width: 100%;
      height: 220px;
      padding: var(--space-4);
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      margin-bottom: var(--space-5);
      resize: none;
    }

    .modal textarea:focus {
      outline: none;
      border-color: var(--primary-500);
    }

    .modal input[type="text"] {
      width: 100%;
      padding: var(--space-3);
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.9375rem;
      margin-bottom: var(--space-5);
    }

    .modal input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-500);
    }

    .modal-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
    }

    /* Move dropdown */
    .move-dropdown {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      min-width: 180px;
      z-index: 9999;
      box-shadow: none;
      display: none;
    }

    .move-dropdown.active {
      display: block;
    }

    .move-dropdown-item {
      padding: var(--space-2) var(--space-3);
      font-size: 0.8125rem;
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .move-dropdown-item:hover {
      background: rgba(249, 115, 22, 0.1);
      color: var(--text-primary);
    }

    .move-dropdown-item.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <script>
    // Load theme immediately to prevent flash
    const { ipcRenderer: themeRenderer } = require('electron');
    themeRenderer.invoke('get-theme').then(theme => {
      document.documentElement.setAttribute('data-theme', theme || 'dark');
    });
  </script>
  <div class="titlebar">
    <div class="titlebar-title">
      <span>DentDoc Bausteine</span>
    </div>
    <div class="titlebar-controls">
      <button class="titlebar-btn" id="minimizeBtn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
          <rect y="5" width="12" height="2" rx="1"/>
        </svg>
      </button>
      <button class="titlebar-btn close" id="closeBtn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
          <path d="M1.5 1.5l9 9m0-9l-9 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="container container-wide">
    <div class="page-header">
      <h1>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
        Dokumentations-Bausteine
      </h1>
      <p>Standard-Aufklärungstexte für die Agent-Kette Dokumentation</p>
    </div>

    <div class="path-info">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
      </svg>
      <span id="bausteinePath">Wird geladen...</span>
      <button class="btn btn-ghost btn-sm" onclick="changePath()">Ändern</button>
      <button class="btn btn-ghost btn-sm" onclick="openFolder()">Öffnen</button>
    </div>

    <div class="info-box">
      <strong>So funktionieren Bausteine:</strong> Wenn die Agent-Kette eine Behandlungskategorie erkennt, wird der entsprechende Aufklärungstext automatisch eingefügt. Die Erkennungshinweise helfen der KI, Ihre praxiseigenen Begriffe den richtigen Kategorien zuzuordnen.
      <br><br>
      <strong>Netzwerk-Tipp:</strong> Speichern Sie die Datei auf einem Netzlaufwerk, damit alle PCs dieselben Bausteine verwenden.
    </div>

    <div class="toolbar">
      <button class="btn btn-primary" onclick="addCategory()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          <line x1="12" y1="11" x2="12" y2="17"/>
          <line x1="9" y1="14" x2="15" y2="14"/>
        </svg>
        Neue Kategorie
      </button>
      <div class="toolbar-right">
        <button class="btn btn-secondary" onclick="showExportModal()">Exportieren</button>
        <button class="btn btn-secondary" onclick="showImportModal()">Importieren</button>
        <button class="btn btn-danger" onclick="confirmResetAll()">Alle zurücksetzen</button>
      </div>
    </div>

    <div class="categories-container" id="categoriesContainer">
      <!-- Wird dynamisch gefüllt -->
    </div>
    </div>
  </div>

  <div class="status-bar">
    <span class="status-message" id="statusMessage">Bereit</span>
    <button class="btn btn-primary btn-sm" id="footerSaveBtn" onclick="saveAllChanges()" disabled>Speichern</button>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Bausteine exportieren
      </h2>
      <textarea id="exportData" readonly></textarea>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="copyExport()">In Zwischenablage</button>
        <button class="btn btn-secondary" onclick="closeModal('exportModal')">Schließen</button>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
        Bausteine importieren
      </h2>
      <textarea id="importData" placeholder="JSON hier einfügen..."></textarea>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="doImport()">Importieren</button>
        <button class="btn btn-secondary" onclick="closeModal('importModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- New Category Modal -->
  <div class="modal-overlay" id="newCategoryModal">
    <div class="modal">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
        </svg>
        Neue Kategorie
      </h2>
      <input type="text" id="newCategoryName" placeholder="Name der Kategorie...">
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="createCategory()">Erstellen</button>
        <button class="btn btn-secondary" onclick="closeModal('newCategoryModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- New Baustein Modal -->
  <div class="modal-overlay" id="newBausteinModal">
    <div class="modal">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <line x1="12" y1="8" x2="12" y2="16"/>
          <line x1="8" y1="12" x2="16" y2="12"/>
        </svg>
        Neuer Baustein
      </h2>
      <input type="text" id="newBausteinName" placeholder="Name des Bausteins (z.B. 'Prophylaxe')...">
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="createBaustein()">Erstellen</button>
        <button class="btn btn-secondary" onclick="closeModal('newBausteinModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Unsaved Changes Modal -->
  <div class="modal-overlay" id="unsavedModal">
    <div class="modal">
      <h2>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--primary-500)" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        Ungespeicherte Änderungen
      </h2>
      <p style="color: var(--text-secondary); margin-bottom: var(--space-5);">
        Sie haben ungespeicherte Änderungen. Möchten Sie diese vor dem Schließen speichern?
      </p>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="saveAndClose()">Speichern & Schließen</button>
        <button class="btn btn-danger" onclick="discardAndClose()">Verwerfen</button>
        <button class="btn btn-secondary" onclick="closeModal('unsavedModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // Window controls
    document.getElementById('minimizeBtn').addEventListener('click', () => {
      ipcRenderer.send('minimize-window');
    });

    document.getElementById('closeBtn').addEventListener('click', async () => {
      if (hasUnsavedChanges) {
        showUnsavedChangesModal();
      } else {
        ipcRenderer.send('close-window');
      }
    });

    let bausteineData = null;
    let defaultsData = null;
    let hasUnsavedChanges = false;
    let openBausteinId = null;
    let currentCategoryForNewBaustein = null;

    // Initialisierung
    document.addEventListener('DOMContentLoaded', async () => {
      await loadBausteine();
      renderCategories();
    });

    async function loadBausteine() {
      try {
        const result = await ipcRenderer.invoke('get-bausteine-with-categories');
        bausteineData = JSON.parse(JSON.stringify(result.data));
        defaultsData = JSON.parse(JSON.stringify(result.defaults));
        document.getElementById('bausteinePath').textContent = result.path;
      } catch (error) {
        showStatus('Fehler beim Laden: ' + error.message, 'error');
      }
    }

    function renderCategories() {
      const container = document.getElementById('categoriesContainer');
      container.innerHTML = '';

      if (!bausteineData || !bausteineData.categories) return;

      for (const category of bausteineData.categories) {
        const categoryEl = document.createElement('div');
        categoryEl.className = 'category';
        categoryEl.dataset.id = category.id;

        categoryEl.innerHTML = `
          <div class="category-header" onclick="toggleCategory('${category.id}')">
            <div class="category-title">
              <svg class="category-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
              <span class="category-name">${category.name}</span>
              <span class="category-count">${category.bausteine.length} Bausteine</span>
            </div>
            <div class="category-actions">
              <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); renameCategory('${category.id}')">Umbenennen</button>
              <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); deleteCategory('${category.id}')">Löschen</button>
              <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); addBaustein('${category.id}')">+ Baustein</button>
            </div>
          </div>
          <div class="category-content">
            <div class="bausteine-list" id="bausteine-${category.id}">
              ${category.bausteine.length === 0 ? `
                <div class="empty-category">
                  Keine Bausteine in dieser Kategorie
                  <br>
                  <button class="btn btn-secondary btn-sm" onclick="addBaustein('${category.id}')">Baustein hinzufügen</button>
                </div>
              ` : category.bausteine.map(b => renderBaustein(b, category.id)).join('')}
            </div>
          </div>
        `;

        container.appendChild(categoryEl);
      }
    }

    function renderBaustein(baustein, categoryId) {
      const isOpen = openBausteinId === baustein.id;
      const isCustom = isBausteinCustom(baustein.id);

      return `
        <div class="baustein-item ${isOpen ? 'open' : ''}" data-id="${baustein.id}" data-category="${categoryId}">
          <div class="baustein-header" onclick="toggleBaustein('${baustein.id}')">
            <div class="baustein-title">
              <svg class="baustein-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"/>
              </svg>
              <span class="baustein-name">${baustein.name}</span>
              <span class="baustein-id">${baustein.id}</span>
            </div>
            <div class="baustein-meta">
              <span class="badge ${isCustom ? 'badge-custom' : 'badge-default'}">
                ${isCustom ? 'Angepasst' : 'Standard'}
              </span>
            </div>
          </div>
          <div class="baustein-content">
            <div class="baustein-content-inner">
              <div class="baustein-field">
                <label>Name</label>
                <input type="text" value="${baustein.name}" oninput="updateBausteinField('${baustein.id}', 'name', this.value)">
              </div>
              <div class="baustein-field">
                <label>Aufklärungstext</label>
                <textarea oninput="updateBausteinField('${baustein.id}', 'standardText', this.value)">${baustein.standardText}</textarea>
              </div>
              <div class="baustein-field">
                <label>Erkennungshinweise (kommagetrennt)</label>
                <input type="text" value="${(baustein.keywords || []).join(', ')}" oninput="updateBausteinField('${baustein.id}', 'keywords', this.value)">
              </div>
              <div class="baustein-actions">
                <div class="baustein-actions-left">
                  <div style="position: relative;">
                    <button class="btn-icon" title="Verschieben" onclick="showMoveDropdown('${baustein.id}', event)">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
                      </svg>
                    </button>
                    <div class="move-dropdown" id="move-${baustein.id}">
                      ${renderMoveOptions(baustein.id, categoryId)}
                    </div>
                  </div>
                  <button class="btn-icon danger" title="Löschen" onclick="deleteBaustein('${baustein.id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </div>
                <button class="btn-reset" onclick="resetBaustein('${baustein.id}')" ${!isCustom ? 'disabled' : ''}>
                  Auf Standard zurücksetzen
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderMoveOptions(bausteinId, currentCategoryId) {
      if (!bausteineData || !bausteineData.categories) return '';

      return bausteineData.categories.map(cat => {
        const isDisabled = cat.id === currentCategoryId;
        const onclickHandler = isDisabled ? '' : `onclick="moveBaustein('${bausteinId}', '${cat.id}')"`;
        return `
          <div class="move-dropdown-item ${isDisabled ? 'disabled' : ''}" ${onclickHandler}>
            ${cat.name}
          </div>
        `;
      }).join('');
    }

    function toggleCategory(categoryId) {
      const categoryEl = document.querySelector(`.category[data-id="${categoryId}"]`);
      if (categoryEl) {
        categoryEl.classList.toggle('collapsed');
      }
    }

    function toggleBaustein(bausteinId) {
      const wasOpen = openBausteinId === bausteinId;
      openBausteinId = wasOpen ? null : bausteinId;

      document.querySelectorAll('.baustein-item').forEach(item => {
        if (item.dataset.id === bausteinId && !wasOpen) {
          item.classList.add('open');
        } else {
          item.classList.remove('open');
        }
      });

      // Close any open move dropdowns
      document.querySelectorAll('.move-dropdown').forEach(d => d.classList.remove('active'));
    }

    function showMoveDropdown(bausteinId, event) {
      event.stopPropagation();
      const dropdown = document.getElementById(`move-${bausteinId}`);
      const button = event.currentTarget;

      // Close all other dropdowns
      document.querySelectorAll('.move-dropdown').forEach(d => {
        if (d !== dropdown) d.classList.remove('active');
      });

      // Position berechnen für fixed positioning
      const rect = button.getBoundingClientRect();
      const dropdownHeight = 200; // Geschätzte Höhe
      const spaceBelow = window.innerHeight - rect.bottom;

      // Dropdown nach oben öffnen wenn nicht genug Platz unten
      if (spaceBelow < dropdownHeight && rect.top > dropdownHeight) {
        dropdown.style.bottom = (window.innerHeight - rect.top + 4) + 'px';
        dropdown.style.top = 'auto';
      } else {
        dropdown.style.top = (rect.bottom + 4) + 'px';
        dropdown.style.bottom = 'auto';
      }
      dropdown.style.left = rect.left + 'px';

      dropdown.classList.toggle('active');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      // Nicht schließen wenn auf ein Dropdown-Item geklickt wurde
      if (e.target.classList.contains('move-dropdown-item')) return;
      document.querySelectorAll('.move-dropdown').forEach(d => d.classList.remove('active'));
    });

    function isBausteinCustom(bausteinId) {
      if (!defaultsData || !defaultsData.categories) return true;

      // Find default baustein
      let defaultBaustein = null;
      for (const cat of defaultsData.categories) {
        const found = cat.bausteine.find(b => b.id === bausteinId);
        if (found) {
          defaultBaustein = found;
          break;
        }
      }

      if (!defaultBaustein) return true;

      // Find current baustein
      let currentBaustein = null;
      for (const cat of bausteineData.categories) {
        const found = cat.bausteine.find(b => b.id === bausteinId);
        if (found) {
          currentBaustein = found;
          break;
        }
      }

      if (!currentBaustein) return true;

      return currentBaustein.standardText !== defaultBaustein.standardText ||
             currentBaustein.name !== defaultBaustein.name ||
             JSON.stringify(currentBaustein.keywords) !== JSON.stringify(defaultBaustein.keywords);
    }

    function updateBausteinField(bausteinId, field, value) {
      for (const cat of bausteineData.categories) {
        const baustein = cat.bausteine.find(b => b.id === bausteinId);
        if (baustein) {
          if (field === 'keywords') {
            baustein.keywords = value.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
          } else {
            baustein[field] = value;
          }
          break;
        }
      }

      hasUnsavedChanges = true;
      showStatus('Ungespeicherte Änderungen', 'warning');
      document.getElementById('footerSaveBtn').disabled = false;
    }

    async function saveAllChanges() {
      try {
        await ipcRenderer.invoke('save-bausteine-with-categories', bausteineData);
        hasUnsavedChanges = false;
        showStatus('Gespeichert!', 'success');
        document.getElementById('footerSaveBtn').disabled = true;

        // Reload to sync state
        await loadBausteine();
        renderCategories();
      } catch (error) {
        showStatus('Fehler beim Speichern: ' + error.message, 'error');
      }
    }

    // Category management
    function addCategory() {
      document.getElementById('newCategoryName').value = '';
      document.getElementById('newCategoryModal').classList.add('active');
      document.getElementById('newCategoryName').focus();
    }

    async function createCategory() {
      const name = document.getElementById('newCategoryName').value.trim();
      if (!name) return;

      try {
        const result = await ipcRenderer.invoke('create-category', name);
        await loadBausteine();
        renderCategories();
        closeModal('newCategoryModal');
        showStatus(`Kategorie "${name}" erstellt`, 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    async function renameCategory(categoryId) {
      const cat = bausteineData.categories.find(c => c.id === categoryId);
      if (!cat) return;

      const newName = prompt('Neuer Name für die Kategorie:', cat.name);
      if (!newName || newName === cat.name) return;

      try {
        await ipcRenderer.invoke('rename-category', categoryId, newName);
        await loadBausteine();
        renderCategories();
        showStatus(`Kategorie umbenannt zu "${newName}"`, 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    async function deleteCategory(categoryId) {
      const cat = bausteineData.categories.find(c => c.id === categoryId);
      if (!cat) return;

      const confirmed = await ipcRenderer.invoke('confirm-delete-category', cat.name);
      if (!confirmed) return;

      try {
        await ipcRenderer.invoke('delete-category', categoryId);
        await loadBausteine();
        renderCategories();
        showStatus(`Kategorie "${cat.name}" gelöscht`, 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    // Baustein management
    function addBaustein(categoryId) {
      currentCategoryForNewBaustein = categoryId;
      document.getElementById('newBausteinName').value = '';
      document.getElementById('newBausteinModal').classList.add('active');
      document.getElementById('newBausteinName').focus();
    }

    async function createBaustein() {
      const name = document.getElementById('newBausteinName').value.trim();
      if (!name || !currentCategoryForNewBaustein) return;

      try {
        const result = await ipcRenderer.invoke('create-baustein', currentCategoryForNewBaustein, {
          name,
          standardText: 'Aufklärungstext hier eingeben...',
          keywords: []
        });
        await loadBausteine();
        renderCategories();
        closeModal('newBausteinModal');
        showStatus(`Baustein "${name}" erstellt`, 'success');

        // Open the new baustein
        openBausteinId = result.baustein.id;
        renderCategories();
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    async function deleteBaustein(bausteinId) {
      let baustein = null;
      for (const cat of bausteineData.categories) {
        baustein = cat.bausteine.find(b => b.id === bausteinId);
        if (baustein) break;
      }
      if (!baustein) return;

      const confirmed = await ipcRenderer.invoke('confirm-delete-baustein', baustein.name);
      if (!confirmed) return;

      try {
        await ipcRenderer.invoke('delete-baustein', bausteinId);
        await loadBausteine();
        renderCategories();
        showStatus(`Baustein "${baustein.name}" gelöscht`, 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    async function moveBaustein(bausteinId, targetCategoryId) {
      try {
        await ipcRenderer.invoke('move-baustein', bausteinId, targetCategoryId);
        await loadBausteine();
        renderCategories();
        showStatus('Baustein verschoben', 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    async function resetBaustein(bausteinId) {
      let baustein = null;
      for (const cat of bausteineData.categories) {
        baustein = cat.bausteine.find(b => b.id === bausteinId);
        if (baustein) break;
      }
      if (!baustein) return;

      const confirmed = await ipcRenderer.invoke('confirm-reset-baustein', baustein.name);
      if (!confirmed) return;

      try {
        await ipcRenderer.invoke('reset-baustein', bausteinId);
        await loadBausteine();
        renderCategories();
        showStatus(`"${baustein.name}" zurückgesetzt`, 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    async function confirmResetAll() {
      const confirmed = await ipcRenderer.invoke('confirm-reset-all-bausteine');
      if (!confirmed) return;

      try {
        await ipcRenderer.invoke('reset-all-bausteine');
        await loadBausteine();
        renderCategories();
        hasUnsavedChanges = false;
        document.getElementById('footerSaveBtn').disabled = true;
        showStatus('Alle Bausteine zurückgesetzt', 'success');
      } catch (error) {
        showStatus('Fehler: ' + error.message, 'error');
      }
    }

    // Path management
    async function changePath() {
      const result = await ipcRenderer.invoke('select-folder');
      if (!result) return;

      const newPath = result + '\\bausteine.json';

      // Dialog anzeigen um zu entscheiden was passieren soll
      const dialogResult = await ipcRenderer.invoke('show-bausteine-path-dialog', newPath);

      if (dialogResult.action === 'cancel') {
        return;
      }

      let statusMsg = '';

      if (dialogResult.action === 'copy_current') {
        // Aktuelle Bausteine in neuen Ordner kopieren
        await ipcRenderer.invoke('copy-bausteine-to-path', newPath);
        statusMsg = 'Bausteine kopiert und Speicherort geändert';
      } else if (dialogResult.action === 'use_existing') {
        // Nur Pfad ändern, vorhandene Datei nutzen
        await ipcRenderer.invoke('set-bausteine-path', newPath);
        statusMsg = 'Vorhandene Bausteine-Datei wird verwendet';
      } else if (dialogResult.action === 'use_defaults') {
        // Pfad ändern, Defaults werden automatisch geladen
        await ipcRenderer.invoke('set-bausteine-path', newPath);
        statusMsg = 'Speicherort geändert (Standard-Bausteine)';
      }

      document.getElementById('bausteinePath').textContent = newPath;

      // Reload bausteine from new path
      await loadBausteine();
      renderCategories();
      hasUnsavedChanges = false;
      document.getElementById('footerSaveBtn').disabled = true;
      showStatus(statusMsg, 'success');
    }

    async function openFolder() {
      const path = document.getElementById('bausteinePath').textContent;
      const folderPath = path.substring(0, path.lastIndexOf('\\'));
      await ipcRenderer.invoke('open-folder', folderPath);
    }

    // Import/Export
    async function showExportModal() {
      const data = await ipcRenderer.invoke('export-bausteine');
      document.getElementById('exportData').value = data;
      document.getElementById('exportModal').classList.add('active');
    }

    function showImportModal() {
      document.getElementById('importData').value = '';
      document.getElementById('importModal').classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function copyExport() {
      const data = document.getElementById('exportData').value;
      navigator.clipboard.writeText(data);
      showStatus('In Zwischenablage kopiert!', 'success');
    }

    async function doImport() {
      const data = document.getElementById('importData').value;

      try {
        await ipcRenderer.invoke('import-bausteine', data);
        await loadBausteine();
        renderCategories();
        closeModal('importModal');
        showStatus('Bausteine importiert!', 'success');
      } catch (error) {
        showStatus('Import fehlgeschlagen: ' + error.message, 'error');
      }
    }

    function showStatus(message, type = '') {
      const el = document.getElementById('statusMessage');
      el.textContent = message;
      el.className = 'status-message ' + type;
    }

    // Unsaved changes dialog
    function showUnsavedChangesModal() {
      document.getElementById('unsavedModal').classList.add('active');
    }

    async function saveAndClose() {
      await saveAllChanges();
      closeModal('unsavedModal');
      ipcRenderer.send('close-window');
    }

    function discardAndClose() {
      hasUnsavedChanges = false;
      closeModal('unsavedModal');
      ipcRenderer.send('close-window');
    }

    // Handle Enter key in modals
    document.getElementById('newCategoryName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') createCategory();
    });

    document.getElementById('newBausteinName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') createBaustein();
    });
  </script>
</body>
</html>
