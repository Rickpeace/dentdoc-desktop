<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DentDoc Login</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <link rel="stylesheet" href="../node_modules/driver.js/dist/driver.css">
  <link rel="stylesheet" href="styles/onboarding-tour.css">
  <style>
    .content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: var(--space-5);
    }

    .login-container {
      width: 100%;
      max-width: 420px;
      animation: slideUp 0.4s ease-out;
    }

    .login-card {
      background: var(--glass-bg);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-2xl);
      padding: var(--space-8);
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
    }

    .login-card::after {
      display: none;
    }

    .logo {
      text-align: center;
      margin-bottom: var(--space-8);
      position: relative;
      z-index: 1;
    }

    .logo-inline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-bottom: var(--space-2);
    }

    .logo-inline svg {
      flex-shrink: 0;
    }

    .logo h1 {
      font-family: 'Manrope', var(--font-sans);
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
      line-height: 1;
      background: none;
      -webkit-background-clip: unset;
      -webkit-text-fill-color: #111827;
      background-clip: unset;
    }

    [data-theme="dark"] .logo h1 {
      color: var(--text-primary);
      -webkit-text-fill-color: var(--text-primary);
    }

    .logo p {
      color: var(--text-tertiary);
      font-size: 0.9375rem;
    }

    .form-content {
      position: relative;
      z-index: 1;
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-500);
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-5);
      font-size: 0.875rem;
      display: none;
      animation: slideUp 0.2s ease-out;
    }

    .error.show {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .error::before {
      content: '!';
      width: 20px;
      height: 20px;
      background: var(--error-500);
      color: white;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .form-group {
      margin-bottom: var(--space-5);
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
      font-weight: 500;
      color: var(--text-secondary);
    }

    .form-group label svg {
      width: 16px;
      height: 16px;
      opacity: 0.6;
    }

    .form-group input {
      height: 48px;
      font-size: 1rem;
    }

    .submit-btn {
      width: 100%;
      height: 52px;
      font-size: 1rem;
      margin-top: var(--space-2);
    }

    .loading {
      display: none;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-top: var(--space-4);
      color: var(--text-tertiary);
      font-size: 0.875rem;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass-border);
      border-top-color: var(--primary-500);
      border-radius: var(--radius-full);
      animation: spin 0.8s linear infinite;
    }

    .info {
      text-align: center;
      margin-top: var(--space-6);
      padding-top: var(--space-5);
      border-top: 1px solid var(--border-default);
      font-size: 0.8125rem;
      color: var(--text-muted);
    }

    .info a {
      color: var(--primary-500);
      text-decoration: none;
      font-weight: 500;
    }

    .info a:hover {
      text-decoration: underline;
    }

    /* Decorative elements - disabled */
    .decoration {
      display: none;
    }

    /* Light theme overrides */
    [data-theme="light"] .login-card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: none;
    }

    [data-theme="light"] .login-card::before {
      background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.2), transparent);
    }

    [data-theme="light"] .login-card::after {
      display: none;
    }

    [data-theme="light"] .error {
      background: #fef2f2;
      border-color: #fecaca;
    }

    [data-theme="light"] .spinner {
      border-color: #e5e7eb;
      border-top-color: var(--primary-500);
    }
  </style>
</head>
<body>
  <script>
    // Load theme immediately to prevent flash
    const { ipcRenderer: themeRenderer } = require('electron');
    themeRenderer.invoke('get-theme').then(theme => {
      document.documentElement.setAttribute('data-theme', theme || 'dark');
    });
  </script>
  <div class="decoration decoration-1"></div>
  <div class="decoration decoration-2"></div>

  <div class="titlebar">
    <div class="titlebar-title">
      <span>DentDoc</span>
    </div>
    <div class="titlebar-controls">
      <button class="titlebar-btn" id="minimizeBtn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
          <rect y="5" width="12" height="2" rx="1"/>
        </svg>
      </button>
      <button class="titlebar-btn close" id="closeBtn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
          <path d="M1.5 1.5l9 9m0-9l-9 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="content">
    <div class="login-container">
      <div class="login-card">
        <div class="logo">
          <div class="logo-inline">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
            </svg>
            <h1>DentDoc</h1>
          </div>
        </div>

        <div class="form-content">
          <div id="error" class="error"></div>

          <form id="loginForm">
            <div class="form-group">
              <label for="email">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <path d="m22 6-10 7L2 6"/>
                </svg>
                E-Mail
              </label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="ihre.email@beispiel.de"
                required
                autofocus
              >
            </div>

            <div class="form-group">
              <label for="password">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                Passwort
              </label>
              <input
                type="password"
                id="password"
                name="password"
                placeholder="••••••••"
                required
              >
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary btn-lg submit-btn">
              Anmelden
            </button>

            <div id="loading" class="loading">
              <div class="spinner"></div>
              <span>Anmeldung läuft...</span>
            </div>
          </form>

          <div class="info">
            <p>Noch kein Konto? <a href="https://dentdoc.app" target="_blank">Jetzt registrieren</a></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    // Window controls
    document.getElementById('minimizeBtn').addEventListener('click', () => {
      ipcRenderer.send('minimize-window');
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      ipcRenderer.send('close-window');
    });

    const form = document.getElementById('loginForm');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');
    const loadingDiv = document.getElementById('loading');

    // Function to resize window to fit content
    function resizeWindowToFit() {
      setTimeout(() => {
        ipcRenderer.invoke('resize-login-window', document.body.scrollHeight);
      }, 50);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      // Show loading
      submitBtn.disabled = true;
      loadingDiv.classList.add('show');
      errorDiv.classList.remove('show');

      try {
        const result = await ipcRenderer.invoke('login', email, password);

        if (result.success) {
          // Login successful, window will be closed by main process
        } else {
          // Show error
          errorDiv.textContent = result.error || 'Anmeldung fehlgeschlagen';
          errorDiv.classList.add('show');
          submitBtn.disabled = false;
          loadingDiv.classList.remove('show');
          resizeWindowToFit();
        }
      } catch (error) {
        errorDiv.textContent = 'Verbindungsfehler. Bitte versuchen Sie es erneut.';
        errorDiv.classList.add('show');
        submitBtn.disabled = false;
        loadingDiv.classList.remove('show');
        resizeWindowToFit();
      }
    });

    // Onboarding Tour for Login
    const { driver } = require('driver.js');

    function createLoginTour() {
      return driver({
        showProgress: true,
        progressText: 'Schritt {{current}} von {{total}}',
        nextBtnText: 'Weiter',
        prevBtnText: 'Zurück',
        doneBtnText: 'Los geht\'s!',
        showButtons: ['next', 'previous', 'close'],
        animate: true,
        allowClose: true,
        overlayClickNext: false,
        disableActiveInteraction: true,
        stagePadding: 10,
        stageRadius: 12,
        popoverClass: 'dentdoc-tour',
        steps: [
          {
            element: '.logo',
            popover: {
              title: 'Willkommen bei DentDoc!',
              description: 'Schön, dass Sie hier sind! DentDoc ist Ihre Desktop-App für automatische Dokumentation in der Zahnarztpraxis.',
              side: 'bottom',
              align: 'center'
            }
          },
          {
            element: '#loginForm',
            popover: {
              title: 'Anmeldung mit Website-Konto',
              description: 'Verwenden Sie hier <strong>dieselben Anmeldedaten</strong> wie auf der DentDoc-Website. Haben Sie noch kein Konto? Registrieren Sie sich zuerst auf dentdoc.app',
              side: 'top',
              align: 'center'
            }
          },
          {
            element: '.info',
            popover: {
              title: 'Noch kein Konto?',
              description: 'Klicken Sie hier, um sich auf der Website zu registrieren. Nach der Registrierung können Sie sich mit denselben Daten hier anmelden.',
              side: 'top',
              align: 'center'
            }
          }
        ],
        onDestroyed: () => {
          ipcRenderer.invoke('mark-tour-completed', 'login');
        }
      });
    }

    // Check if this is first run and start tour automatically
    async function checkFirstRunLogin() {
      console.log('Checking first run for login tour...');
      const isFirstRun = await ipcRenderer.invoke('check-first-run', 'login');
      console.log('Is first run:', isFirstRun);
      if (isFirstRun) {
        setTimeout(() => {
          console.log('Starting login tour...');
          const tourDriver = createLoginTour();
          tourDriver.drive();
        }, 600);
      }
    }

    checkFirstRunLogin();

    // Zum Testen: Tour manuell starten mit Tastenkombination Strg+T
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        console.log('Manual tour start...');
        const tourDriver = createLoginTour();
        tourDriver.drive();
      }
    });
  </script>
</body>
</html>
