<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DentDoc Einstellungen</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <link rel="stylesheet" href="../node_modules/driver.js/dist/driver.css">
  <link rel="stylesheet" href="styles/onboarding-tour.css">
  <style>
    .page-header {
      margin-bottom: var(--space-6);
      animation: slideUp 0.3s ease-out;
    }

    .page-header h1 {
      margin-bottom: var(--space-2);
    }

    .page-header p {
      color: var(--text-tertiary);
    }

    .hint-banner {
      background: linear-gradient(135deg, rgba(249, 115, 22, 0.15), rgba(249, 115, 22, 0.05));
      border: 1px solid rgba(249, 115, 22, 0.3);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
      font-size: 0.875rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      animation: slideUp 0.35s ease-out;
    }

    [data-theme="light"] .hint-banner {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #9a3412;
    }

    .hint-banner svg {
      flex-shrink: 0;
      color: var(--primary-500);
    }

    [data-theme="light"] .hint-banner svg {
      color: #ea580c;
    }

    .save-confirmation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
      color: white;
      padding: var(--space-5) var(--space-8);
      border-radius: var(--radius-xl);
      font-size: 1.125rem;
      font-weight: 600;
      box-shadow: none;
      z-index: 1000;
      display: none;
      animation: savePopup 0.8s ease-out forwards;
    }

    @keyframes savePopup {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
      40% { transform: translate(-50%, -50%) scale(1); }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
    }

    .section {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      transition: all var(--transition-normal);
      position: relative;
      animation: slideUp 0.4s ease-out;
      animation-fill-mode: both;
    }

    .section:nth-child(1) { animation-delay: 0.05s; }
    .section:nth-child(2) { animation-delay: 0.1s; }
    .section:nth-child(3) { animation-delay: 0.15s; }
    .section:nth-child(4) { animation-delay: 0.2s; }
    .section:nth-child(5) { animation-delay: 0.25s; }
    .section:nth-child(6) { animation-delay: 0.3s; }
    .section:nth-child(7) { animation-delay: 0.35s; }

    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    }

    [data-theme="light"] .section::before {
      background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.15), transparent);
    }

    .section:hover {
      background: var(--glass-bg-hover);
      border-color: var(--glass-border-hover);
      box-shadow: none;
    }

    .section h2 {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-5);
      font-size: 1.125rem;
    }

    .section h2 svg {
      width: 22px;
      height: 22px;
      color: var(--primary-500);
    }

    .mic-test {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      margin-top: var(--space-4);
    }

    .mic-level {
      flex: 1;
      height: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    [data-theme="light"] .mic-level {
      background: #e5e7eb;
      border-color: #d1d5db;
    }

    .mic-level-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--success-500), var(--primary-500), var(--error-500));
      width: 0%;
      transition: width 0.1s;
      box-shadow: none;
    }

    .status {
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      margin-top: var(--space-4);
      border: 1px solid;
      display: none;
    }

    .status.show {
      display: block;
    }

    .status.success {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success-500);
      border-color: rgba(34, 197, 94, 0.3);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-500);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .status.info {
      background: rgba(249, 115, 22, 0.1);
      color: var(--primary-500);
      border-color: rgba(249, 115, 22, 0.3);
    }

    .shortcut-input {
      display: flex;
      gap: var(--space-3);
      align-items: center;
    }

    .shortcut-input input[type="text"] {
      flex: 1;
      margin-bottom: 0;
    }

    .shortcut-display {
      flex: 1;
      padding: var(--space-4);
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      font-family: var(--font-mono);
      font-size: 1rem;
      text-align: center;
      color: var(--text-primary);
      font-weight: 600;
      letter-spacing: 2px;
    }

    [data-theme="light"] .shortcut-display {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .shortcut-display.recording {
      border-color: var(--primary-500);
      background: rgba(249, 115, 22, 0.1);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
      animation: pulse 1s ease-in-out infinite;
    }

    [data-theme="light"] .shortcut-display.recording {
      background: #fff7ed;
    }

    .current-shortcut {
      font-size: 0.875rem;
      color: var(--text-tertiary);
      margin-bottom: var(--space-3);
    }

    .current-shortcut strong {
      color: var(--primary-500);
      font-family: var(--font-mono);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      cursor: pointer;
      padding: var(--space-3);
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
      margin: calc(-1 * var(--space-3));
      margin-bottom: var(--space-3);
    }

    .checkbox-label:hover {
      background: var(--glass-bg);
    }

    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .checkbox-label span {
      font-size: 0.9375rem;
      color: var(--text-primary);
    }

    .debug-buttons {
      display: flex;
      gap: var(--space-3);
    }

    .debug-buttons button {
      flex: 1;
    }

    .buttons {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      margin-top: var(--space-8);
      padding-top: var(--space-6);
      border-top: 1px solid var(--border-default);
    }

    .buttons button {
      min-width: 120px;
    }
  </style>
</head>
<body>
  <script>
    // Load theme immediately to prevent flash
    const { ipcRenderer: themeRenderer } = require('electron');
    themeRenderer.invoke('get-theme').then(theme => {
      document.documentElement.setAttribute('data-theme', theme || 'dark');
    });
  </script>
  <div class="titlebar">
    <div class="titlebar-title">
      <span>DentDoc Einstellungen</span>
    </div>
    <div class="titlebar-controls">
      <button class="titlebar-btn" id="minimizeBtn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
          <rect y="5" width="12" height="2" rx="1"/>
        </svg>
      </button>
      <button class="titlebar-btn close" id="closeBtn">
        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
          <path d="M1.5 1.5l9 9m0-9l-9 9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="main-content">
    <div class="container">
      <div class="page-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h1>Einstellungen</h1>
            <p>Passen Sie DentDoc an Ihre Bedürfnisse an</p>
          </div>
          <button id="startTourBtn" class="tour-restart-btn" title="Geführte Tour starten">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Tour starten
          </button>
        </div>
      </div>

    <div class="hint-banner">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4M12 8h.01"/>
      </svg>
      <span>Änderungen werden erst nach Klick auf "Speichern" übernommen.</span>
    </div>

    <div id="saveConfirmation" class="save-confirmation">
      ✓ Gespeichert
    </div>

    <!-- Microphone Section -->
    <div id="section-mic" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
        Mikrofon
        <span class="help-icon">?<span class="tooltip">Wählen Sie hier Ihr Mikrofon aus und testen Sie die Aufnahmequalität. Ein gutes Mikrofon ist wichtig für präzise Transkriptionen.</span></span>
      </h2>

      <label for="micSelect">Mikrofon auswählen</label>
      <select id="micSelect">
        <option value="">Lade Mikrofone...</option>
      </select>

      <div class="mic-test">
        <button id="testMicBtn" class="btn btn-secondary">Test starten</button>
        <div class="mic-level">
          <div id="micLevelBar" class="mic-level-bar"></div>
        </div>
      </div>

      <div id="micStatus" class="status info"></div>

      <button id="openSoundSettingsBtn" class="btn btn-secondary w-full mt-4">
        Windows Sound-Einstellungen öffnen
      </button>
      <p class="helper-text">Hier können Sie die Mikrofon-Lautstärke in Windows anpassen.</p>
    </div>

    <!-- Shortcut Section -->
    <div id="section-shortcut" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="4" width="20" height="16" rx="2"/>
          <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h8M6 16h.01M18 16h.01"/>
        </svg>
        Tastenkombination
        <span class="help-icon">?<span class="tooltip">Drücken Sie F9 (oder Ihre gewählte Taste), um eine Aufnahme zu starten oder zu stoppen. Sie können die Taste hier ändern.</span></span>
      </h2>

      <label>Aufnahme starten/stoppen</label>
      <p class="current-shortcut">Aktuelle Tastenkombination: <strong id="currentShortcut">F9</strong></p>

      <div class="shortcut-input">
        <div id="shortcutDisplay" class="shortcut-display">F9</div>
        <button id="recordShortcutBtn" class="btn btn-secondary">Ändern</button>
      </div>

      <div id="shortcutStatus" class="status info"></div>
    </div>

    <!-- Transcript Export Section -->
    <div id="section-export" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
        </svg>
        Transkript-Export
        <span class="help-icon">?<span class="tooltip">Aktivieren Sie diese Option, um alle Transkriptionen automatisch als Textdateien zu speichern.</span></span>
      </h2>

      <label class="checkbox-label">
        <input type="checkbox" id="autoExportCheckbox">
        <span>Transkripte speichern</span>
      </label>

      <div id="exportPathSection">
        <label for="transcriptPath">Speicherort</label>
        <div class="shortcut-input">
          <input type="text" id="transcriptPath" readonly>
          <button id="browseTranscriptBtn" class="btn btn-secondary">Ändern</button>
          <button id="openTranscriptFolderBtn" class="btn btn-ghost">Öffnen</button>
        </div>
        <p class="helper-text">Transkripte werden als TXT-Dateien gespeichert (Datum_Uhrzeit.txt)</p>
      </div>
    </div>

    <!-- Recordings Section -->
    <div id="section-recordings" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        Aufnahmen
        <span class="help-icon">?<span class="tooltip">Optional können Sie die Audio-Aufnahmen dauerhaft speichern für Qualitätskontrolle oder spätere Referenz.</span></span>
      </h2>

      <label class="checkbox-label">
        <input type="checkbox" id="keepAudioCheckbox">
        <span>Aufnahmen speichern</span>
      </label>

      <label for="recordingsPath">Speicherort</label>
      <div class="shortcut-input">
        <input type="text" id="recordingsPath" readonly>
        <button id="browseRecordingsBtn" class="btn btn-secondary">Ändern</button>
        <button id="openRecordingsFolderBtn" class="btn btn-ghost">Öffnen</button>
      </div>
      <p class="helper-text">Aufnahmen werden hier gespeichert wenn aktiviert.</p>
    </div>

    <!-- Voice Profiles Section -->
    <div id="section-profiles" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        Stimmprofile
        <span class="help-icon">?<span class="tooltip">Mit Stimmprofilen erkennt DentDoc verschiedene Sprecher automatisch. So wird klar, wer was gesagt hat.</span></span>
      </h2>

      <label for="profilesPath">Speicherort für Stimmprofile</label>
      <div class="shortcut-input">
        <input type="text" id="profilesPath" readonly>
        <button id="browseProfilesBtn" class="btn btn-secondary">Ändern</button>
        <button id="openProfilesFolderBtn" class="btn btn-ghost">Öffnen</button>
      </div>
      <p class="helper-text warning">Für mehrere PCs: Wählen Sie einen Netzwerkordner (z.B. \\server\dentdoc\profiles)</p>
    </div>

    <!-- Bausteine Section -->
    <div id="section-bausteine" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
        Bausteine
        <span class="help-icon">?<span class="tooltip">Bausteine sind vordefinierte Textvorlagen, die automatisch in Ihre Dokumentation eingefügt werden können.</span></span>
      </h2>

      <label for="bausteinePath">Speicherort für Bausteine-Datei</label>
      <div class="shortcut-input">
        <input type="text" id="bausteinePath" readonly>
        <button id="browseBausteineBtn" class="btn btn-secondary">Ändern</button>
        <button id="openBausteineFolderBtn" class="btn btn-ghost">Öffnen</button>
      </div>
      <p class="helper-text warning">Für mehrere PCs: Wählen Sie einen Netzwerkordner, damit alle PCs dieselben Bausteine verwenden.</p>
    </div>

    <!-- Documentation Mode Section -->
    <div id="section-docmode" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        </svg>
        Dokumentations-Modus
        <span class="help-icon">?<span class="tooltip">Single Prompt: Schnelle Dokumentation. Agent-Kette: Erkennt Behandlungstypen und fügt passende Bausteine automatisch ein.</span></span>
      </h2>

      <label for="docModeSelect">Modus auswählen</label>
      <select id="docModeSelect">
        <option value="single">Single Prompt (Standard)</option>
        <option value="agent-chain">Agent-Kette mit Bausteinen</option>
      </select>
      <p class="helper-text">
        <strong>Single Prompt:</strong> Ein KI-Aufruf für die gesamte Dokumentation.<br>
        <strong>Agent-Kette:</strong> Erkennt Behandlungskategorien und fügt automatisch Standard-Aufklärungstexte hinzu.
      </p>
    </div>

    <!-- Appearance Section -->
    <div id="section-appearance" class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        Erscheinungsbild
        <span class="help-icon">?<span class="tooltip">Wählen Sie zwischen hellem und dunklem Design - ganz nach Ihrem Geschmack.</span></span>
      </h2>

      <label for="themeSelect">Design</label>
      <select id="themeSelect">
        <option value="dark">Dunkel</option>
        <option value="light">Hell</option>
      </select>
      <p class="helper-text">Wählen Sie zwischen hellem und dunklem Design.</p>
    </div>

    <!-- Behavior Section -->
    <div class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
        Verhalten
        <span class="help-icon">?<span class="tooltip">Stellen Sie ein, ob das Status-Fenster nach erfolgreicher Transkription automatisch geschlossen werden soll.</span></span>
      </h2>

      <label class="checkbox-label">
        <input type="checkbox" id="autoCloseCheckbox">
        <span>Status-Fenster automatisch schließen nach erfolgreicher Transkription</span>
      </label>
    </div>

    <!-- Debug Section -->
    <div class="section">
      <h2>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 19l7-7 3 3-7 7-3-3z"/>
          <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
          <path d="M2 2l7.586 7.586"/>
          <circle cx="11" cy="11" r="2"/>
        </svg>
        Debug & Fehlerprotokoll
        <span class="help-icon">?<span class="tooltip">Bei Problemen können Sie das Debug-Protokoll öffnen und an den Support senden.</span></span>
      </h2>

      <p class="helper-text" style="margin-top: 0; margin-bottom: var(--space-4);">
        Bei Problemen können Sie das Debug-Protokoll an den Support senden.
      </p>

      <div class="debug-buttons">
        <button id="openLogBtn" class="btn btn-secondary">Protokoll öffnen</button>
        <button id="copyLogPathBtn" class="btn btn-secondary">Pfad kopieren</button>
      </div>

      <div id="logStatus" class="status info"></div>
    </div>

    <!-- Buttons -->
    <div class="buttons">
      <button id="cancelBtn" class="btn btn-secondary">Abbrechen</button>
      <button id="saveBtn" class="btn btn-primary">Speichern</button>
    </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let selectedMicId = null;
    let newShortcut = null;
    let isRecordingShortcut = false;
    let isTesting = false;
    let audioContext = null;
    let mediaStream = null;
    let analyser = null;
    let hasUnsavedChanges = false;
    let initialSettings = {};

    // Elements
    const micSelect = document.getElementById('micSelect');
    const testMicBtn = document.getElementById('testMicBtn');
    const openSoundSettingsBtn = document.getElementById('openSoundSettingsBtn');
    const micLevelBar = document.getElementById('micLevelBar');
    const micStatus = document.getElementById('micStatus');
    const shortcutDisplay = document.getElementById('shortcutDisplay');
    const currentShortcut = document.getElementById('currentShortcut');
    const recordShortcutBtn = document.getElementById('recordShortcutBtn');
    const shortcutStatus = document.getElementById('shortcutStatus');
    const transcriptPath = document.getElementById('transcriptPath');
    const browseTranscriptBtn = document.getElementById('browseTranscriptBtn');
    const openTranscriptFolderBtn = document.getElementById('openTranscriptFolderBtn');
    const profilesPath = document.getElementById('profilesPath');
    const browseProfilesBtn = document.getElementById('browseProfilesBtn');
    const openProfilesFolderBtn = document.getElementById('openProfilesFolderBtn');
    const autoCloseCheckbox = document.getElementById('autoCloseCheckbox');
    const autoExportCheckbox = document.getElementById('autoExportCheckbox');
    const keepAudioCheckbox = document.getElementById('keepAudioCheckbox');
    const docModeSelect = document.getElementById('docModeSelect');
    const recordingsPath = document.getElementById('recordingsPath');
    const browseRecordingsBtn = document.getElementById('browseRecordingsBtn');
    const openRecordingsFolderBtn = document.getElementById('openRecordingsFolderBtn');
    const openLogBtn = document.getElementById('openLogBtn');
    const copyLogPathBtn = document.getElementById('copyLogPathBtn');
    const logStatus = document.getElementById('logStatus');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const themeSelect = document.getElementById('themeSelect');
    const bausteinePath = document.getElementById('bausteinePath');
    const browseBausteineBtn = document.getElementById('browseBausteineBtn');
    const openBausteineFolderBtn = document.getElementById('openBausteineFolderBtn');

    // Load current settings
    async function loadSettings() {
      const settings = await ipcRenderer.invoke('get-settings');

      currentShortcut.textContent = settings.shortcut || 'F9';
      shortcutDisplay.textContent = settings.shortcut || 'F9';
      selectedMicId = settings.microphoneId || null;
      transcriptPath.value = settings.transcriptPath || '';
      profilesPath.value = settings.profilesPath || '';
      recordingsPath.value = settings.recordingsPath || '';
      autoCloseCheckbox.checked = settings.autoClose || false;
      autoExportCheckbox.checked = settings.autoExport || false;
      keepAudioCheckbox.checked = settings.keepAudio || false;
      docModeSelect.value = settings.docMode || 'single';

      // Load bausteine path
      const bausteinePathValue = await ipcRenderer.invoke('get-bausteine-path');
      bausteinePath.value = bausteinePathValue || '';

      // Load theme
      const theme = settings.theme || 'dark';
      themeSelect.value = theme;
      document.documentElement.setAttribute('data-theme', theme);

      // Load microphones
      await loadMicrophones();

      // Store initial settings for change detection
      initialSettings = {
        shortcut: settings.shortcut || 'F9',
        microphoneId: selectedMicId,
        transcriptPath: settings.transcriptPath || '',
        profilesPath: settings.profilesPath || '',
        recordingsPath: settings.recordingsPath || '',
        bausteinePath: bausteinePathValue || '',
        autoClose: settings.autoClose || false,
        autoExport: settings.autoExport || false,
        keepAudio: settings.keepAudio || false,
        docMode: settings.docMode || 'single',
        theme: settings.theme || 'dark'
      };
    }

    // Check if settings have changed
    function checkForChanges() {
      const currentSettings = {
        shortcut: newShortcut || shortcutDisplay.textContent,
        microphoneId: micSelect.value,
        transcriptPath: transcriptPath.value,
        profilesPath: profilesPath.value,
        recordingsPath: recordingsPath.value,
        bausteinePath: bausteinePath.value,
        autoClose: autoCloseCheckbox.checked,
        autoExport: autoExportCheckbox.checked,
        keepAudio: keepAudioCheckbox.checked,
        docMode: docModeSelect.value,
        theme: themeSelect.value
      };

      hasUnsavedChanges = JSON.stringify(currentSettings) !== JSON.stringify(initialSettings);
    }

    // Load available microphones
    async function loadMicrophones() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const mics = devices.filter(d => d.kind === 'audioinput');

        micSelect.innerHTML = '';

        if (mics.length === 0) {
          micSelect.innerHTML = '<option value="">Kein Mikrofon gefunden</option>';
          return;
        }

        mics.forEach((mic, index) => {
          const option = document.createElement('option');
          option.value = mic.deviceId;
          option.textContent = mic.label || `Mikrofon ${index + 1}`;
          if (mic.deviceId === selectedMicId) {
            option.selected = true;
          }
          micSelect.appendChild(option);
        });

        // Select first if none selected
        if (!selectedMicId && mics.length > 0) {
          selectedMicId = mics[0].deviceId;
        }
      } catch (error) {
        console.error('Error loading microphones:', error);
        micSelect.innerHTML = '<option value="">Fehler beim Laden</option>';
      }
    }

    // Test microphone
    testMicBtn.addEventListener('click', async () => {
      if (isTesting) {
        stopMicTest();
        return;
      }

      try {
        isTesting = true;
        testMicBtn.textContent = 'Test stoppen';
        testMicBtn.classList.remove('btn-secondary');
        testMicBtn.classList.add('btn-danger');

        const constraints = {
          audio: selectedMicId ? { deviceId: { exact: selectedMicId } } : true
        };

        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        audioContext = new AudioContext();
        const source = audioContext.createMediaStreamSource(mediaStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        showStatus(micStatus, 'Sprechen Sie ins Mikrofon...', 'info');

        // Visualize audio level
        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        function updateLevel() {
          if (!isTesting) return;

          analyser.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
          const level = Math.min(100, (average / 128) * 100);
          micLevelBar.style.width = level + '%';

          requestAnimationFrame(updateLevel);
        }

        updateLevel();
      } catch (error) {
        console.error('Mic test error:', error);
        showStatus(micStatus, 'Fehler: ' + error.message, 'error');
        stopMicTest();
      }
    });

    function stopMicTest() {
      isTesting = false;
      testMicBtn.textContent = 'Test starten';
      testMicBtn.classList.remove('btn-danger');
      testMicBtn.classList.add('btn-secondary');
      micLevelBar.style.width = '0%';

      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      hideStatus(micStatus);
    }

    // Microphone selection change
    micSelect.addEventListener('change', () => {
      selectedMicId = micSelect.value;
      if (isTesting) {
        stopMicTest();
      }
      checkForChanges();
    });

    // Track changes on all inputs
    transcriptPath.addEventListener('input', checkForChanges);
    profilesPath.addEventListener('input', checkForChanges);
    recordingsPath.addEventListener('input', checkForChanges);
    autoCloseCheckbox.addEventListener('change', checkForChanges);
    autoExportCheckbox.addEventListener('change', checkForChanges);
    keepAudioCheckbox.addEventListener('change', checkForChanges);
    docModeSelect.addEventListener('change', checkForChanges);

    // Theme selection - apply immediately for preview
    themeSelect.addEventListener('change', () => {
      document.documentElement.setAttribute('data-theme', themeSelect.value);
      checkForChanges();
    });

    // Open Windows sound settings
    openSoundSettingsBtn.addEventListener('click', async () => {
      await ipcRenderer.invoke('open-sound-settings');
    });

    // Record shortcut
    recordShortcutBtn.addEventListener('click', async () => {
      if (isRecordingShortcut) {
        isRecordingShortcut = false;
        recordShortcutBtn.textContent = 'Ändern';
        shortcutDisplay.classList.remove('recording');
        hideStatus(shortcutStatus);
        // Re-enable global shortcut
        await ipcRenderer.invoke('enable-global-shortcut');
        return;
      }

      // Disable global shortcut while recording new one
      await ipcRenderer.invoke('disable-global-shortcut');

      isRecordingShortcut = true;
      recordShortcutBtn.textContent = 'Abbrechen';
      shortcutDisplay.classList.add('recording');
      shortcutDisplay.textContent = 'Drücken Sie eine Taste...';
      showStatus(shortcutStatus, 'Drücken Sie die gewünschte Tastenkombination (z.B. F9, Strg+Shift+R)', 'info');
    });

    // Capture keyboard shortcut
    document.addEventListener('keydown', (e) => {
      if (!isRecordingShortcut) return;

      e.preventDefault();
      e.stopPropagation();

      const parts = [];
      if (e.ctrlKey) parts.push('Ctrl');
      if (e.altKey) parts.push('Alt');
      if (e.shiftKey) parts.push('Shift');

      // Get the key name
      let key = e.key;
      if (key === ' ') key = 'Space';
      else if (key.length === 1) key = key.toUpperCase();
      else if (key.startsWith('Arrow')) key = key.replace('Arrow', '');

      // Don't allow modifier-only shortcuts
      if (['Control', 'Alt', 'Shift', 'Meta'].includes(key)) {
        return;
      }

      parts.push(key);
      newShortcut = parts.join('+');

      shortcutDisplay.textContent = newShortcut;
      shortcutDisplay.classList.remove('recording');
      isRecordingShortcut = false;
      recordShortcutBtn.textContent = 'Ändern';

      // Re-enable global shortcut
      ipcRenderer.invoke('enable-global-shortcut');

      showStatus(shortcutStatus, `Neue Tastenkombination: ${newShortcut}`, 'success');
      checkForChanges();
    });

    // Browse for transcript folder
    browseTranscriptBtn.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-folder');
      if (result) {
        transcriptPath.value = result;
        checkForChanges();
      }
    });

    // Open transcript folder
    openTranscriptFolderBtn.addEventListener('click', async () => {
      if (transcriptPath.value) {
        await ipcRenderer.invoke('open-folder', transcriptPath.value);
      }
    });

    // Browse for profiles folder
    browseProfilesBtn.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-folder');
      if (result) {
        profilesPath.value = result;
        checkForChanges();
      }
    });

    // Open profiles folder
    openProfilesFolderBtn.addEventListener('click', async () => {
      if (profilesPath.value) {
        await ipcRenderer.invoke('open-folder', profilesPath.value);
      }
    });

    // Browse for bausteine folder
    browseBausteineBtn.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-folder');
      if (!result) return;

      const newPath = result + '\\bausteine.json';

      // Dialog anzeigen um zu entscheiden was passieren soll
      const dialogResult = await ipcRenderer.invoke('show-bausteine-path-dialog', newPath);

      if (dialogResult.action === 'cancel') {
        return;
      }

      if (dialogResult.action === 'copy_current') {
        // Aktuelle Bausteine in neuen Ordner kopieren
        await ipcRenderer.invoke('copy-bausteine-to-path', newPath);
      } else if (dialogResult.action === 'use_existing') {
        // Nur Pfad ändern, vorhandene Datei nutzen
        await ipcRenderer.invoke('set-bausteine-path', newPath);
      } else if (dialogResult.action === 'use_defaults') {
        // Pfad ändern, Defaults werden automatisch geladen
        await ipcRenderer.invoke('set-bausteine-path', newPath);
      }

      bausteinePath.value = newPath;
      checkForChanges();
    });

    // Open bausteine folder
    openBausteineFolderBtn.addEventListener('click', async () => {
      if (bausteinePath.value) {
        const folderPath = bausteinePath.value.substring(0, bausteinePath.value.lastIndexOf('\\'));
        await ipcRenderer.invoke('open-folder', folderPath);
      }
    });

    // Browse for recordings folder
    browseRecordingsBtn.addEventListener('click', async () => {
      const result = await ipcRenderer.invoke('select-folder');
      if (result) {
        recordingsPath.value = result;
        checkForChanges();
      }
    });

    // Open recordings folder
    openRecordingsFolderBtn.addEventListener('click', async () => {
      if (recordingsPath.value) {
        await ipcRenderer.invoke('open-folder', recordingsPath.value);
      } else {
        // Open temp folder if no custom path is set
        await ipcRenderer.invoke('open-temp-folder');
      }
    });

    // Save settings
    saveBtn.addEventListener('click', async () => {
      const settings = {
        shortcut: newShortcut || shortcutDisplay.textContent,
        microphoneId: micSelect.value,
        transcriptPath: transcriptPath.value,
        profilesPath: profilesPath.value,
        recordingsPath: recordingsPath.value,
        autoClose: autoCloseCheckbox.checked,
        autoExport: autoExportCheckbox.checked,
        keepAudio: keepAudioCheckbox.checked,
        docMode: docModeSelect.value,
        theme: themeSelect.value
      };

      try {
        await ipcRenderer.invoke('save-settings', settings);
        hasUnsavedChanges = false;

        // Show save confirmation
        const confirmation = document.getElementById('saveConfirmation');
        confirmation.style.display = 'block';

        // Close window after animation
        setTimeout(() => {
          window.close();
        }, 800);
      } catch (error) {
        showStatus(shortcutStatus, 'Fehler beim Speichern: ' + error.message, 'error');
      }
    });

    // Cancel
    cancelBtn.addEventListener('click', async () => {
      if (hasUnsavedChanges) {
        const result = await ipcRenderer.invoke('show-unsaved-changes-dialog');
        if (result === 'save') {
          saveBtn.click();
        } else if (result === 'discard') {
          hasUnsavedChanges = false; // Prevent beforeunload from firing
          window.close();
        }
        // 'cancel' does nothing, stays in settings
      } else {
        window.close();
      }
    });

    // Handle window close (X button)
    window.addEventListener('beforeunload', async (e) => {
      if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';

        const result = await ipcRenderer.invoke('show-unsaved-changes-dialog');
        if (result === 'save') {
          saveBtn.click();
        } else if (result === 'discard') {
          hasUnsavedChanges = false;
          window.close();
        }
      }
    });

    // Debug log handlers
    openLogBtn.addEventListener('click', async () => {
      try {
        await ipcRenderer.invoke('open-debug-log');
        showStatus(logStatus, 'Debug-Protokoll wurde geöffnet', 'success');
        setTimeout(() => hideStatus(logStatus), 3000);
      } catch (error) {
        showStatus(logStatus, 'Fehler: ' + error.message, 'error');
      }
    });

    copyLogPathBtn.addEventListener('click', async () => {
      try {
        const path = await ipcRenderer.invoke('get-debug-log-path');
        await navigator.clipboard.writeText(path);
        showStatus(logStatus, 'Pfad kopiert: ' + path, 'success');
        setTimeout(() => hideStatus(logStatus), 3000);
      } catch (error) {
        showStatus(logStatus, 'Fehler: ' + error.message, 'error');
      }
    });

    // Helper functions
    function showStatus(element, message, type) {
      element.textContent = message;
      element.className = 'status ' + type + ' show';
    }

    function hideStatus(element) {
      element.classList.remove('show');
    }

    // Initialize
    loadSettings();

    // Onboarding Tour
    const { driver } = require('driver.js');
    const startTourBtn = document.getElementById('startTourBtn');

    function createTour() {
      return driver({
        showProgress: true,
        progressText: 'Schritt {{current}} von {{total}}',
        nextBtnText: 'Weiter',
        prevBtnText: 'Zurück',
        doneBtnText: 'Fertig',
        showButtons: ['next', 'previous', 'close'],
        animate: true,
        allowClose: true,
        overlayClickNext: false,
        disableActiveInteraction: true,
        stagePadding: 10,
        stageRadius: 12,
        popoverClass: 'dentdoc-tour',
        steps: [
          {
            popover: {
              title: 'Willkommen bei DentDoc!',
              description: 'Diese kurze Tour zeigt Ihnen die wichtigsten Funktionen. Sie können die Tour jederzeit beenden oder später erneut starten.',
              side: 'center',
              align: 'center'
            }
          },
          {
            element: '#section-mic',
            popover: {
              title: 'Mikrofon-Einstellungen',
              description: 'Wählen Sie hier Ihr Mikrofon aus und testen Sie die Aufnahmequalität. Ein gutes Mikrofon ist wichtig für präzise Transkriptionen.',
              side: 'bottom',
              align: 'start'
            }
          },
          {
            element: '#section-shortcut',
            popover: {
              title: 'Tastenkombination',
              description: 'Drücken Sie F9 (oder Ihre gewählte Taste), um eine Aufnahme zu starten oder zu stoppen. Sie können die Taste hier ändern.',
              side: 'bottom',
              align: 'start'
            }
          },
          {
            element: '#section-export',
            popover: {
              title: 'Transkript-Export',
              description: 'Aktivieren Sie diese Option, um alle Transkriptionen automatisch als Textdateien zu speichern.',
              side: 'bottom',
              align: 'start'
            }
          },
          {
            element: '#section-recordings',
            popover: {
              title: 'Aufnahmen speichern',
              description: 'Optional können Sie die Audio-Aufnahmen dauerhaft speichern für Qualitätskontrolle oder spätere Referenz.',
              side: 'bottom',
              align: 'start'
            }
          },
          {
            element: '#section-profiles',
            popover: {
              title: 'Stimmprofile',
              description: 'Mit Stimmprofilen erkennt DentDoc verschiedene Sprecher automatisch. So wird klar, wer was gesagt hat.',
              side: 'top',
              align: 'start'
            }
          },
          {
            element: '#section-bausteine',
            popover: {
              title: 'Bausteine',
              description: 'Bausteine sind vordefinierte Textvorlagen, die automatisch in Ihre Dokumentation eingefügt werden können.',
              side: 'top',
              align: 'start'
            }
          },
          {
            element: '#section-docmode',
            popover: {
              title: 'Dokumentations-Modus',
              description: 'Single Prompt: Schnelle Dokumentation. Agent-Kette: Erkennt Behandlungstypen und fügt passende Bausteine automatisch ein.',
              side: 'top',
              align: 'start'
            }
          },
          {
            element: '#section-appearance',
            popover: {
              title: 'Erscheinungsbild',
              description: 'Wählen Sie zwischen hellem und dunklem Design - ganz nach Ihrem Geschmack.',
              side: 'top',
              align: 'start'
            }
          },
          {
            element: '#saveBtn',
            popover: {
              title: 'Einstellungen speichern',
              description: 'Vergessen Sie nicht, Ihre Änderungen zu speichern! Klicken Sie auf "Speichern", wenn Sie fertig sind.',
              side: 'top',
              align: 'end'
            }
          },
          {
            popover: {
              title: 'Sie sind startklar!',
              description: 'Drücken Sie F9, um Ihre erste Aufnahme zu starten. Das Status-Fenster zeigt Ihnen den Fortschritt an. Viel Erfolg!',
              side: 'center',
              align: 'center'
            }
          }
        ],
        onDestroyed: () => {
          ipcRenderer.invoke('mark-tour-completed', 'settings');
        }
      });
    }

    // Start tour button click handler
    startTourBtn.addEventListener('click', () => {
      const tourDriver = createTour();
      tourDriver.drive();
    });

    // Check if this is first run and start tour automatically
    async function checkFirstRun() {
      const isFirstRun = await ipcRenderer.invoke('check-first-run', 'settings');
      if (isFirstRun) {
        // Wait a bit for the page to fully render
        setTimeout(() => {
          const tourDriver = createTour();
          tourDriver.drive();
        }, 800);
      }
    }

    checkFirstRun();

    // Listen for show-settings-tab event (from error overlay)
    ipcRenderer.on('show-settings-tab', (event, tab) => {
      if (tab === 'microphone') {
        const micSection = document.getElementById('section-mic');
        if (micSection) {
          micSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
          micSection.style.transition = 'background-color 0.3s ease';
          micSection.style.backgroundColor = 'rgba(var(--accent-rgb), 0.1)';
          setTimeout(() => {
            micSection.style.backgroundColor = '';
          }, 2000);
        }
      }
    });

    // Window controls
    document.getElementById('minimizeBtn').addEventListener('click', () => {
      ipcRenderer.send('minimize-window');
    });

    document.getElementById('closeBtn').addEventListener('click', () => {
      if (hasUnsavedChanges) {
        cancelBtn.click();
      } else {
        window.close();
      }
    });
  </script>
</body>
</html>
