<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>DentDoc Status</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: transparent;
      overflow: hidden;
    }

    .container {
      background: rgba(30, 30, 30, 0.98);
      border-radius: 14px;
      padding: 20px 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      -webkit-app-region: drag;
    }

    .icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .icon.recording {
      background: #ef4444;
      transition: transform 0.1s ease-out;
    }

    .icon.processing {
      background: #f97316;
      animation: processingPulse 1.5s ease-in-out infinite;
    }

    @keyframes processingPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.08); opacity: 0.85; }
    }

    .icon.success {
      background: #22c55e;
    }

    .icon.error {
      background: #ef4444;
    }

    .content {
      flex: 1;
    }

    .title {
      color: white;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .message {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
    }

    .timer {
      color: rgba(255, 255, 255, 0.4);
      font-variant-numeric: tabular-nums;
      margin-left: 6px;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: rgba(255, 255, 255, 0.5);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      -webkit-app-region: no-drag;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* Progress Bar */
    .progress-container {
      display: none;
      margin-top: 16px;
    }

    .progress-container.visible {
      display: block;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #f97316, #fb923c);
      border-radius: 3px;
      transition: width 0.5s ease-out;
      width: 0%;
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 1.5s infinite;
    }

    .progress-fill.complete {
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }

    .progress-fill.complete::after {
      animation: none;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .progress-step.active {
      color: #f97316;
    }

    .progress-step.done {
      color: #22c55e;
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
    }

    .progress-step.active .step-dot {
      background: #f97316;
      animation: dotPulse 1s ease-in-out infinite;
    }

    .progress-step.done .step-dot {
      background: #22c55e;
    }

    @keyframes dotPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Actions */
    .actions {
      display: none;
      flex-direction: column;
      margin-top: 18px;
      gap: 12px;
    }

    .actions.visible {
      display: flex;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      padding: 16px 18px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 14px;
      -webkit-app-region: no-drag;
      text-align: left;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn .btn-icon {
      width: 46px;
      height: 46px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .action-btn.summary .btn-icon {
      background: linear-gradient(135deg, #f97316, #ea580c);
    }

    .action-btn.full .btn-icon {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .action-btn .btn-text {
      flex: 1;
    }

    .action-btn .btn-title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 3px;
    }

    .action-btn .btn-desc {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .action-btn .btn-status {
      font-size: 20px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .action-btn.copied .btn-status {
      opacity: 1;
    }

    .action-btn.copied {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.4);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div id="icon" class="icon recording">
        <span id="iconEmoji">ðŸ”´</span>
      </div>
      <div class="content">
        <div id="title" class="title">Aufnahme lÃ¤uft...</div>
        <div id="message" class="message">DrÃ¼cken Sie F9 zum Stoppen <span id="timer" class="timer"></span></div>
      </div>
      <button id="closeBtn" class="close-btn">âœ•</button>
    </div>

    <div id="progressContainer" class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div class="progress-steps">
        <div id="step1" class="progress-step">
          <span class="step-dot"></span>
          <span>Upload</span>
        </div>
        <div id="step2" class="progress-step">
          <span class="step-dot"></span>
          <span>Transkription</span>
        </div>
        <div id="step3" class="progress-step">
          <span class="step-dot"></span>
          <span>Sprecher</span>
        </div>
        <div id="step4" class="progress-step">
          <span class="step-dot"></span>
          <span>Dokumentation</span>
        </div>
      </div>
    </div>

    <div id="actions" class="actions">
      <button id="copySummaryBtn" class="action-btn summary">
        <div class="btn-icon">ðŸ“‹</div>
        <div class="btn-text">
          <div class="btn-title">Zusammenfassung</div>
          <div class="btn-desc">KI-generierte Dokumentation kopieren</div>
        </div>
        <div class="btn-status">âœ“</div>
      </button>
      <button id="copyFullBtn" class="action-btn full">
        <div class="btn-icon">ðŸ“„</div>
        <div class="btn-text">
          <div class="btn-title">Komplette Unterhaltung</div>
          <div class="btn-desc">Transkript + Dokumentation kopieren</div>
        </div>
        <div class="btn-status">âœ“</div>
      </button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    const icon = document.getElementById('icon');
    const iconEmoji = document.getElementById('iconEmoji');
    const title = document.getElementById('title');
    const message = document.getElementById('message');
    const closeBtn = document.getElementById('closeBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const actions = document.getElementById('actions');
    const copySummaryBtn = document.getElementById('copySummaryBtn');
    const copyFullBtn = document.getElementById('copyFullBtn');

    let currentDocumentation = null;
    let currentTranscript = null;
    let currentState = null;
    let timerInterval = null;
    let recordingStartTime = null;

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function startTimer() {
      stopTimer(); // Clear any existing timer
      recordingStartTime = Date.now();
      const timerEl = document.getElementById('timer');
      if (timerEl) timerEl.textContent = '0:00';
      timerInterval = setInterval(() => {
        const timerEl = document.getElementById('timer');
        if (timerEl) {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          timerEl.textContent = formatTime(elapsed);
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function resetSteps() {
      step1.className = 'progress-step';
      step2.className = 'progress-step';
      step3.className = 'progress-step';
      step4.className = 'progress-step';
      progressFill.style.width = '0%';
      progressFill.classList.remove('complete');
    }

    function setProgress(step, percent, isComplete = false) {
      progressFill.style.width = percent + '%';

      if (isComplete) {
        progressFill.classList.add('complete');
        step1.className = 'progress-step done';
        step2.className = 'progress-step done';
        step3.className = 'progress-step done';
        step4.className = 'progress-step done';
      } else {
        progressFill.classList.remove('complete');
        if (step >= 1) step1.className = step === 1 ? 'progress-step active' : 'progress-step done';
        if (step >= 2) step2.className = step === 2 ? 'progress-step active' : 'progress-step done';
        if (step >= 3) step3.className = step === 3 ? 'progress-step active' : 'progress-step done';
        if (step >= 4) step4.className = step === 4 ? 'progress-step active' : 'progress-step done';
      }
    }

    function updateAudioLevel(level) {
      // level should be between 0 and 1
      const normalizedLevel = Math.max(0, Math.min(1, level));

      // Scale the icon based on audio level (1.0 to 1.5 scale)
      // Boost the input significantly to make effect more visible
      const boostedLevel = Math.min(1, normalizedLevel * 4);
      const scale = 1 + (boostedLevel * 0.5);
      icon.style.transform = `scale(${scale})`;
    }

    ipcRenderer.on('update-status', (event, data) => {
      title.textContent = data.title;
      currentState = data.type;

      // Reset icon classes and scale
      icon.className = 'icon ' + data.type;
      icon.style.transform = 'scale(1)';

      // Set emoji and progress based on type
      switch (data.type) {
        case 'recording':
          iconEmoji.textContent = 'ðŸ”´';
          message.innerHTML = data.message + ' <span id="timer" class="timer"></span>';
          startTimer();
          progressContainer.classList.remove('visible');
          actions.classList.remove('visible');
          resetSteps();
          break;
        case 'processing':
          stopTimer();
          iconEmoji.textContent = '';
          message.textContent = data.message;
          progressContainer.classList.add('visible');
          actions.classList.remove('visible');
          // Set progress based on step (4 steps total)
          if (data.step === 1) {
            setProgress(1, 15);   // Upload: 15%
          } else if (data.step === 2) {
            setProgress(2, 40);   // Transkription: 40%
          } else if (data.step === 3) {
            setProgress(3, 65);   // Sprecher: 65%
          } else if (data.step === 4) {
            setProgress(4, 90);   // Dokumentation: 90%
          }
          break;
        case 'success':
          stopTimer();
          iconEmoji.textContent = 'âœ…';
          message.textContent = data.message;
          progressContainer.classList.remove('visible');
          if (data.documentation) {
            currentDocumentation = data.documentation;
            currentTranscript = data.transcript;
            actions.classList.add('visible');
            copySummaryBtn.classList.remove('copied');
            copyFullBtn.classList.remove('copied');
          }
          break;
        case 'error':
          stopTimer();
          iconEmoji.textContent = 'âŒ';
          message.textContent = data.message;
          progressContainer.classList.remove('visible');
          actions.classList.remove('visible');
          break;
      }
    });

    closeBtn.addEventListener('click', () => {
      if (currentState === 'recording') {
        // Cancel recording - don't process
        ipcRenderer.send('cancel-recording');
      }
      ipcRenderer.send('close-status-overlay');
    });

    copySummaryBtn.addEventListener('click', () => {
      if (currentDocumentation) {
        ipcRenderer.invoke('copy-to-clipboard', currentDocumentation);
        showCopied(copySummaryBtn);
      }
    });

    copyFullBtn.addEventListener('click', () => {
      if (currentTranscript && currentDocumentation) {
        const fullText = '--- Dokumentation ---\n\n' + currentDocumentation + '\n\n--- Transkript ---\n\n' + currentTranscript;
        ipcRenderer.invoke('copy-to-clipboard', fullText);
        showCopied(copyFullBtn);
      } else if (currentDocumentation) {
        ipcRenderer.invoke('copy-to-clipboard', currentDocumentation);
        showCopied(copyFullBtn);
      }
    });

    function showCopied(btn) {
      btn.classList.add('copied');
      setTimeout(() => {
        btn.classList.remove('copied');
      }, 2000);
    }

    // Listen for audio level updates
    ipcRenderer.on('audio-level', (event, level) => {
      updateAudioLevel(level);
    });
  </script>
</body>
</html>
