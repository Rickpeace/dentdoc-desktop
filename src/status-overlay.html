<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>DentDoc Status</title>
  <link rel="stylesheet" href="styles/design-system.css">
  <style>
    html, body {
      background: transparent;
      overflow: hidden;
      padding: 0;
      margin: 0;
      min-height: auto;
      min-width: auto;
      height: auto !important;
      width: auto !important;
      display: block;
    }

    body {
      padding: 2px;
    }

    body::before {
      display: none;
    }

    .container {
      background: var(--overlay-bg, rgba(10, 10, 11, 0.95));
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-radius: var(--radius-xl);
      padding: var(--space-5) var(--space-6);
      border: 1px solid var(--overlay-border, rgba(255, 255, 255, 0.1));
      position: relative;
      box-shadow: none;
      width: 400px;
    }

    [data-theme="light"] .container {
      --overlay-bg: rgba(255, 255, 255, 0.95);
      --overlay-border: rgba(0, 0, 0, 0.1);
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
    }

    .header {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    /* Drag handle for moving the window */
    .drag-handle {
      position: absolute;
      top: 0;
      left: 0;
      right: 50px;
      height: 50px;
      cursor: move;
      -webkit-app-region: drag;
    }

    .icon {
      width: 52px;
      height: 52px;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
      position: relative;
      transition: transform 0.1s ease-out;
    }

    .icon.recording {
      background: linear-gradient(135deg, var(--error-500), #dc2626);
      box-shadow: none;
      animation: recordingPulse 1.5s ease-in-out infinite;
    }

    @keyframes recordingPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .icon.processing {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      box-shadow: none;
      animation: processingPulse 1.5s ease-in-out infinite;
    }

    @keyframes processingPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .icon.success {
      background: linear-gradient(135deg, var(--success-500), var(--success-600));
      box-shadow: none;
    }

    .icon.error {
      background: linear-gradient(135deg, var(--error-500), var(--error-600));
      box-shadow: none;
    }

    .content {
      flex: 1;
      min-width: 0;
    }

    .title {
      color: var(--text-primary);
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .message {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .settings-link {
      display: block;
      margin-top: 8px;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: opacity 0.15s ease;
    }

    .settings-link:hover {
      opacity: 0.8;
      text-decoration: underline;
    }

    .timer {
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
      font-family: var(--font-mono);
      margin-left: var(--space-2);
      font-size: 0.8125rem;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.08);
      border: none;
      color: var(--text-tertiary);
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      -webkit-app-region: no-drag;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--text-primary);
    }

    /* Progress Bar */
    .progress-container {
      display: none;
      margin-top: var(--space-5);
    }

    .progress-container.visible {
      display: block;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-500), var(--primary-400));
      border-radius: var(--radius-full);
      transition: width 0.5s ease-out;
      width: 0%;
      position: relative;
      overflow: hidden;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: shimmer 1.5s infinite;
    }

    .progress-fill.complete {
      background: linear-gradient(90deg, var(--success-500), var(--success-600));
    }

    .progress-fill.complete::after {
      animation: none;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-3);
      font-size: 0.6875rem;
      color: var(--text-muted);
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      transition: color var(--transition-fast);
    }

    .progress-step.active {
      color: var(--primary-500);
    }

    .progress-step.done {
      color: var(--success-500);
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: var(--radius-full);
      background: rgba(255, 255, 255, 0.2);
      transition: all var(--transition-fast);
    }

    .progress-step.active .step-dot {
      background: var(--primary-500);
      box-shadow: none;
      animation: dotPulse 1s ease-in-out infinite;
    }

    .progress-step.done .step-dot {
      background: var(--success-500);
    }

    @keyframes dotPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }

    /* Actions */
    .actions {
      display: none;
      flex-direction: column;
      margin-top: var(--space-5);
      gap: var(--space-3);
    }

    .actions.visible {
      display: flex;
    }

    .action-btn {
      width: 100%;
      box-sizing: border-box;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      padding: var(--space-4) var(--space-5);
      border-radius: var(--radius-lg);
      font-size: 0.875rem;
      cursor: pointer;
      transition: all var(--transition-normal);
      display: flex;
      align-items: center;
      gap: var(--space-4);
      -webkit-app-region: no-drag;
      text-align: left;
    }

    .action-btn:hover {
      background: var(--glass-bg-hover);
      border-color: var(--glass-border-hover);
      transform: translateY(-2px);
      box-shadow: none;
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn .btn-icon {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .action-btn.summary .btn-icon {
      background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
      box-shadow: none;
    }

    .action-btn.full .btn-icon {
      background: linear-gradient(135deg, var(--info-500), var(--info-600));
      box-shadow: none;
    }

    .action-btn .btn-text {
      flex: 1;
      min-width: 0;
    }

    .action-btn .btn-title {
      font-weight: 600;
      font-size: 0.9375rem;
      margin-bottom: 2px;
    }

    .action-btn .btn-desc {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    .action-btn .btn-status {
      font-size: 20px;
      opacity: 0;
      transition: all var(--transition-fast);
      color: var(--success-500);
    }

    .action-btn.copied .btn-status {
      opacity: 1;
      transform: scale(1.1);
    }

    .action-btn.copied {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.3);
    }

    /* Light theme overrides */
    [data-theme="light"] .container::before {
      background: linear-gradient(90deg, transparent, rgba(249, 115, 22, 0.2), transparent);
    }

    [data-theme="light"] .close-btn {
      background: rgba(0, 0, 0, 0.05);
    }

    [data-theme="light"] .close-btn:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    [data-theme="light"] .progress-bar {
      background: #e5e7eb;
    }

    [data-theme="light"] .step-dot {
      background: #d1d5db;
    }

    [data-theme="light"] .action-btn {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    [data-theme="light"] .action-btn:hover {
      background: #f9fafb;
      border-color: #fdba74;
    }

    [data-theme="light"] .action-btn.copied {
      background: #f0fdf4;
      border-color: #bbf7d0;
    }
  </style>
</head>
<body>
  <script>
    // Load theme immediately to prevent flash
    const { ipcRenderer: themeRenderer } = require('electron');
    themeRenderer.invoke('get-theme').then(theme => {
      document.documentElement.setAttribute('data-theme', theme || 'dark');
    });
  </script>
  <div class="container">
    <div class="drag-handle"></div>
    <div class="header">
      <div id="icon" class="icon processing">
        <span id="iconEmoji">âš¡</span>
      </div>
      <div class="content">
        <div id="title" class="title">Verarbeitung...</div>
        <div id="message" class="message">Upload 0%</div>
      </div>
      <button id="closeBtn" class="close-btn">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 1l12 12M13 1L1 13"/>
        </svg>
      </button>
    </div>

    <div id="progressContainer" class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div class="progress-steps">
        <div id="step1" class="progress-step">
          <span class="step-dot"></span>
          <span>Upload</span>
        </div>
        <div id="step2" class="progress-step">
          <span class="step-dot"></span>
          <span>Transkription</span>
        </div>
        <div id="step3" class="progress-step">
          <span class="step-dot"></span>
          <span>Sprecher</span>
        </div>
        <div id="step4" class="progress-step">
          <span class="step-dot"></span>
          <span>Dokumentation</span>
        </div>
      </div>
    </div>

    <div id="actions" class="actions">
      <button id="copySummaryBtn" class="action-btn summary">
        <div class="btn-icon">ðŸ“‹</div>
        <div class="btn-text">
          <div class="btn-title">Zusammenfassung</div>
          <div class="btn-desc">KI-generierte Dokumentation kopieren</div>
        </div>
        <div class="btn-status">âœ“</div>
      </button>
      <button id="copyFullBtn" class="action-btn full">
        <div class="btn-icon">ðŸ“„</div>
        <div class="btn-text">
          <div class="btn-title">Komplette Unterhaltung</div>
          <div class="btn-desc">Transkript + Dokumentation kopieren</div>
        </div>
        <div class="btn-status">âœ“</div>
      </button>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    const icon = document.getElementById('icon');
    const iconEmoji = document.getElementById('iconEmoji');
    const title = document.getElementById('title');
    const message = document.getElementById('message');
    const closeBtn = document.getElementById('closeBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const actions = document.getElementById('actions');
    const copySummaryBtn = document.getElementById('copySummaryBtn');
    const copyFullBtn = document.getElementById('copyFullBtn');

    let currentDocumentation = null;
    let currentTranscript = null;
    let currentState = null;
    let timerInterval = null;
    let recordingStartTime = null;

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function startTimer() {
      stopTimer(); // Clear any existing timer
      recordingStartTime = Date.now();
      const timerEl = document.getElementById('timer');
      if (timerEl) timerEl.textContent = '0:00';
      timerInterval = setInterval(() => {
        const timerEl = document.getElementById('timer');
        if (timerEl) {
          const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
          timerEl.textContent = formatTime(elapsed);
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function resetSteps() {
      step1.className = 'progress-step';
      step2.className = 'progress-step';
      step3.className = 'progress-step';
      step4.className = 'progress-step';
      progressFill.style.width = '0%';
      progressFill.classList.remove('complete');
    }

    function setProgress(step, percent, isComplete = false) {
      progressFill.style.width = percent + '%';

      if (isComplete) {
        progressFill.classList.add('complete');
        step1.className = 'progress-step done';
        step2.className = 'progress-step done';
        step3.className = 'progress-step done';
        step4.className = 'progress-step done';
      } else {
        progressFill.classList.remove('complete');
        // Reset all steps to grey (not started)
        step1.className = 'progress-step';
        step2.className = 'progress-step';
        step3.className = 'progress-step';
        step4.className = 'progress-step';
        // Mark steps: done (green) for completed, active (orange) for current, grey for not started
        if (step === 1) {
          step1.className = 'progress-step active';
        } else if (step === 2) {
          step1.className = 'progress-step done';
          step2.className = 'progress-step active';
        } else if (step === 3) {
          step1.className = 'progress-step done';
          step2.className = 'progress-step done';
          step3.className = 'progress-step active';
        } else if (step === 4) {
          step1.className = 'progress-step done';
          step2.className = 'progress-step done';
          step3.className = 'progress-step done';
          step4.className = 'progress-step active';
        }
      }
    }

    function updateAudioLevel(level) {
      // level should be between 0 and 1
      const normalizedLevel = Math.max(0, Math.min(1, level));

      // Scale the icon based on audio level (1.0 to 1.5 scale)
      // Boost the input significantly to make effect more visible
      const boostedLevel = Math.min(1, normalizedLevel * 4);
      const scale = 1 + (boostedLevel * 0.5);
      icon.style.transform = `scale(${scale})`;
    }

    ipcRenderer.on('update-status', (event, data) => {
      title.textContent = data.title;
      currentState = data.type;

      // Reset icon classes and scale
      icon.className = 'icon ' + data.type;
      icon.style.transform = 'scale(1)';

      // Set emoji and progress based on type
      switch (data.type) {
        case 'recording':
          iconEmoji.textContent = 'ðŸ”´';
          message.innerHTML = data.message + ' <span id="timer" class="timer"></span>';
          startTimer();
          progressContainer.classList.remove('visible');
          actions.classList.remove('visible');
          resetSteps();
          break;
        case 'processing':
          stopTimer();
          iconEmoji.textContent = 'âš¡';
          message.textContent = data.message;
          progressContainer.classList.add('visible');
          actions.classList.remove('visible');
          // Set progress based on step (4 steps total)
          // Each step gets 25% of the progress bar
          if (data.step === 1) {
            // Upload step: 0-25% based on actual upload progress
            const uploadPercent = data.uploadProgress !== undefined
              ? Math.round(data.uploadProgress * 0.25)  // Scale 0-100% to 0-25%
              : 0;
            setProgress(1, uploadPercent);
          } else if (data.step === 2) {
            setProgress(2, 50);   // Transkription: 25-50%
          } else if (data.step === 3) {
            setProgress(3, 75);   // Sprecher: 50-75%
          } else if (data.step === 4) {
            setProgress(4, 90);   // Dokumentation: 75-100%
          }
          break;
        case 'success':
          stopTimer();
          iconEmoji.textContent = 'âœ…';
          message.textContent = data.message;
          progressContainer.classList.remove('visible');
          if (data.documentation) {
            currentDocumentation = data.documentation;
            currentTranscript = data.transcript;
            actions.classList.add('visible');
            copySummaryBtn.classList.remove('copied');
            copyFullBtn.classList.remove('copied');
          }
          break;
        case 'error':
          stopTimer();
          iconEmoji.textContent = 'âŒ';
          message.innerHTML = data.message;
          progressContainer.classList.remove('visible');
          actions.classList.remove('visible');
          // Add click handler for settings link if present
          const settingsLink = message.querySelector('.settings-link');
          if (settingsLink) {
            settingsLink.addEventListener('click', (e) => {
              e.preventDefault();
              ipcRenderer.send('open-microphone-settings');
            });
          }
          break;
      }
    });

    closeBtn.addEventListener('click', () => {
      if (currentState === 'recording') {
        // Cancel recording - don't process
        ipcRenderer.send('cancel-recording');
      }
      ipcRenderer.send('close-status-overlay');
    });

    copySummaryBtn.addEventListener('click', () => {
      if (currentDocumentation) {
        ipcRenderer.invoke('copy-to-clipboard', currentDocumentation);
        showCopied(copySummaryBtn);
      }
    });

    copyFullBtn.addEventListener('click', () => {
      if (currentTranscript && currentDocumentation) {
        const fullText = '--- Dokumentation ---\n\n' + currentDocumentation + '\n\n--- Transkript ---\n\n' + currentTranscript;
        ipcRenderer.invoke('copy-to-clipboard', fullText);
        showCopied(copyFullBtn);
      } else if (currentDocumentation) {
        ipcRenderer.invoke('copy-to-clipboard', currentDocumentation);
        showCopied(copyFullBtn);
      }
    });

    function showCopied(btn) {
      btn.classList.add('copied');
      setTimeout(() => {
        btn.classList.remove('copied');
      }, 2000);
    }

    // Listen for audio level updates
    ipcRenderer.on('audio-level', (event, level) => {
      updateAudioLevel(level);
    });

    // Auto-resize window to fit content
    function resizeWindowToFit() {
      const container = document.querySelector('.container');
      // Get the actual rendered size including padding and border
      const width = container.offsetWidth + 4; // + body padding (2px each side)
      const height = container.offsetHeight + 4;
      ipcRenderer.send('resize-status-overlay', width, height);
    }

    // Resize after status update (with small delay for DOM to update)
    ipcRenderer.on('update-status', () => {
      setTimeout(resizeWindowToFit, 50);
    });

    // Initial resize when loaded
    window.addEventListener('load', () => {
      setTimeout(resizeWindowToFit, 100);
    });
  </script>
</body>
</html>
